# 技术设计文档

## 1. 目标与范围
- 面向“专家库、抽取规则配置、专家抽取执行”的管理与业务流程。
- 前端采用 Vue3 + Element Plus；后端采用 FastAPI。
- 分层结构：`apis`/`services`/`repo`/`db`。
- 数据库使用 Alembic 管理迁移。
- 具备用户与 RBAC 权限管理，权限以 scope 划分范围。

## 2. 技术栈与关键组件
- 前端：Vue 3、Vite、Element Plus、Pinia、Vue Router、Axios。
- 后端：FastAPI、Pydantic v2、SQLAlchemy 2.x、Alembic、Uvicorn。
- 数据库：关系型数据库（建议 PostgreSQL；也可替换为 MySQL）。
- 认证：OAuth2 Password + JWT；RBAC + scopes 授权。

## 3. 总体架构
- 前端负责表单、列表、抽取流程 UI 与权限提示。
- 后端提供 REST API，按业务领域分模块。
- 数据访问分层：API → Service → Repository → DB。
- 权限控制：API 层依赖注入校验 scopes；服务层进行二次约束与审计。

## 4. 目录结构

### 4.1 前端（示例）
```
frontend/
  src/
    apis/                 # API 请求封装（axios 实例与接口函数）
    services/             # 复杂业务流程组合与数据转换
    stores/               # Pinia 状态管理
    views/                # 页面
    components/           # 公共组件
    router/               # 路由与路由守卫
    types/                # TS 类型
    utils/                # 工具函数
  vite.config.ts
```

### 4.2 后端（示例）
```
backend/
  app/
    main.py               # 应用入口
    core/
      config.py           # 配置
      security.py         # JWT、密码与 scopes 校验
    apis/
      deps.py             # 依赖注入
      v1/
        endpoints/
          auth.py
          users.py
          roles.py
          experts.py
          rules.py
          draws.py
    models/               # ORM 模型
    schemas/              # Pydantic schemas
    services/             # 业务逻辑
    repo/                 # 数据访问
    db/
      base.py             # Base 与模型导入
      session.py          # Session 管理
  alembic/
    versions/             # 迁移脚本
  alembic.ini
```

## 5. 核心模块设计

### 5.1 用户与 RBAC
- 用户表 `users`：账号、密码哈希、状态、基本信息。
- 角色表 `roles`：角色名称、描述。
- 权限表 `permissions`：权限名称、scope。
- 关联表：`user_roles`、`role_permissions`。
- Scope 规范：
  - `expert:read`, `expert:write`
  - `organization:read`, `organization:write`
  - `title:read`, `title:write`
  - `draw:read`, `draw:apply`, `draw:execute`
  - `rule:read`, `rule:write`
  - `user:read`, `user:write`, `role:write`

### 5.2 专家库
- 专家基础信息：姓名、性别、联系方式、单位等。
- 专业信息：工程类/服务类/货物类及子项。
- 回避信息：回避单位、回避人员等。
- 单位与职称通过枚举项管理，可在管理端维护。
- 支持导入/导出（Excel）。

### 5.3 抽取规则
- 规则匹配：专业、职称要求、回避规则。
- 抽取方式：随机、摇号等。
- 替补专家数量配置。

### 5.4 抽取执行
- 根据申请与规则过滤候选专家。
- 随机抽取并生成结果清单。
- 抽取结果包含专家基本与联系信息。

## 6. API 设计要点
- 统一版本路径：`/api/v1`。
- 典型接口：
  - `POST /auth/login`
  - `GET /users` `POST /users`
  - `GET /roles` `POST /roles` `PUT /roles/{id}`
  - `GET /experts` `POST /experts` `PUT /experts/{id}`
  - `POST /experts/import` `GET /experts/export`
  - `GET /organizations` `POST /organizations`
  - `GET /titles` `POST /titles`
  - `POST /draws/apply` `GET /draws`
  - `POST /draws/execute`
  - `GET /rules` `POST /rules`
- 权限校验：使用 `Depends(require_scopes([...]))` 控制接口访问。

## 7. 数据库与迁移
- SQLAlchemy 模型与 Pydantic schemas 对应。
- Alembic 负责版本迁移：
  - 新建迁移：`alembic revision --autogenerate -m "message"`
  - 应用迁移：`alembic upgrade head`
- 迁移脚本在 `alembic/versions/` 下管理。

## 8. 安全与审计
- 密码加密：`passlib` + `bcrypt`。
- JWT 存储 scopes 与用户标识。
- 审计日志：记录抽取申请、执行、修改等关键操作。

## 9. 配置与部署
- 配置项集中在 `core/config.py`，支持环境变量覆盖。
- 运行方式：
  - 开发：`uvicorn app.main:app --reload`
  - 生产：`uvicorn app.main:app --workers N`

# 专业信息管理设计文档

## 1. 背景与目标
- 将“专业类别/子项”从专家、规则、抽取中抽离为可维护的基础数据。
- 支持独立增删改查与停用，统一前后端下拉来源，降低手填错误。
- 保持现有业务流程不变，提供平滑迁移方案。

## 2. 术语
- 专业类别（Category）：工程类、服务类、货物类等一级分类。
- 子项（Subcategory）：类别下的细分项，如土建、电气、咨询等。

## 3. 数据模型设计

### 3.1 新增表
**categories**
- id: int, PK
- name: varchar(50), unique, not null
- code: varchar(50), unique, nullable（可选，便于对接外部编码）
- is_active: bool, default true
- sort_order: int, default 0
- created_at / updated_at

**subcategories**
- id: int, PK
- category_id: int, not null（逻辑关联字段，不加外键）
- name: varchar(80), not null
- code: varchar(50), nullable
- is_active: bool, default true
- sort_order: int, default 0
- created_at / updated_at
- 约束：unique(category_id, name)

### 3.2 业务表引用
**experts**
- 新增：category_id, subcategory_id（逻辑关联，不加外键）
- 保留原 category / subcategory 字段作为兼容字段（迁移期）

**rules**
- 新增：category_id（逻辑关联，不加外键）
- 保留原 category 字段作为兼容字段（迁移期）

**draw_applications**
- 新增：category_id, subcategory_id（逻辑关联，不加外键）
- 保留原 category / subcategory 字段作为兼容字段（迁移期）

### 3.3 删除与约束策略
- 数据库不使用外键约束，引用关系由应用层校验。
- 默认不允许删除已被引用的类别/子项（应用层检查）。
- 若需要“删除”能力，可改为软删除：is_active=false。

## 4. 权限与角色
新增 scopes：
- category:read / category:write
- subcategory:read / subcategory:write

建议角色授权：
- admin: 全部
- rule-admin: category:read, subcategory:read
- operator: category:read, subcategory:read

## 5. API 设计

### 5.1 Categories
- GET `/categories`（category:read）
- POST `/categories`（category:write）
- PUT `/categories/{id}`（category:write）
- DELETE `/categories/{id}`（category:write）
- GET `/categories/tree`（category:read，返回含子项的树）

### 5.2 Subcategories
- GET `/categories/{id}/subcategories`（subcategory:read）
- POST `/categories/{id}/subcategories`（subcategory:write）
- PUT `/subcategories/{id}`（subcategory:write）
- DELETE `/subcategories/{id}`（subcategory:write）

### 5.3 兼容返回
在专家/规则/抽取接口中优先返回：
- category_id / subcategory_id
- 同时返回 category_name / subcategory_name（便于过渡）

## 6. 服务与仓储
新增模块：
- `repo/categories.py`, `repo/subcategories.py`
- `services/categories.py`, `services/subcategories.py`
- `apis/v1/endpoints/categories.py`

关键校验：
- name/code 唯一性
- 子项必须绑定类别（应用层验证）
- 停用/删除时校验是否仍被引用（或允许软停用）

## 7. 前端改造
- 新增“专业管理”页面：类别列表 + 子项管理（建议树形或主从表）。
- 表单改造：专家/规则/抽取选择使用 `el-cascader` 或 “类别下拉 + 子项下拉联动”。
- 新增类型定义 `Category/Subcategory` 与相关 services。
- i18n 增加专业管理文案。

## 8. 数据迁移与兼容方案

### 8.1 迁移步骤
1) 创建 categories/subcategories 表与新列（不加外键）。  
2) 统计现有 experts/rules/draws 中的 category/subcategory，生成基础字典。  
3) 回填 category_id/subcategory_id（按 name 匹配）。  
4) 应用层优先使用 ID；旧字段保留只读。  
5) 运行稳定后再移除旧字段（可选）。  

### 8.2 导入导出
- 导入：支持“类别名/子项名”映射到 ID。  
- 不存在时策略可选：拒绝导入 or 自动创建（建议默认拒绝，后台可开启 auto_create）。  
- 导出：同时导出类别名与子项名。

## 9. 风险与处理
- **重名冲突**：子项在不同类别可重名，用 (category_id, name) 约束解决。  
- **历史数据不规范**：迁移脚本需做清洗与报告。  
- **删除风险**：默认禁止删除被引用数据，前端提示“请先迁移使用记录”。  

## 10. 验收清单
- 专业类别/子项 CRUD 正常，权限生效。  
- 专家/规则/抽取页面下拉使用专业字典。  
- 现有数据可平滑迁移，查询与执行不受影响。  
